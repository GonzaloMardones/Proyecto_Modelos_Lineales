---
title: "Proyecto Modelos Lineales"
author: "Oscar Gamboa, Gonzalo Mardones, Nicolas Montecinos"
date: "`r Sys.Date()`"
output: pdf_document
header-includes: 
  - \usepackage{tikz}
  - \usepackage{pgfplots}
  - \usepackage{amsmath}
  - \usepackage{dutchcal}
---

## Introducción
 - bla bla

### Planteamiento del Problema
<!-- ¿Cuáles son los hechos o fenómenos?; ¿Qué dicen los datos? -->

- Fenomeno: Licencias medicas en funcionarios de educación en Huasco - 2022 han llegado con mucha frecuencia...

### Justificación del Problema
 Las razones que conducen a investigar el fenómeno.
  
  - En funcion del impacto de las licencias medicas.    - caracterizacion de la licencia medica (numeros promedios de días )
  
  
###  Estado del Arte
<!-- ¿Qué se ha dicho del tema en cuestión?; ¿Cómo lo han -->
<!-- investigado?; ¿Qué tipo de metodología utilizan? -->

BUSCAR UNA REFERENCIA A NIVEL NACIONAL PARA DECLARAR EL IMPACTO (DOCENTES Y MEDICOS)
METODOLOGIA DE CONTEO (DESCRIPTIVO) 


### Objetivo General y Objetivo Especifico
<!-- ¿Para qué y cómo abordar la investigación? -->

  - Obj General: 
  se busca caracterizar la catnidad de dias promedios de LM de los docentes contratados bajo la administración del servicio de ed. publica de la provincia de Huasco, con info actualizada ENE-2022 a OCT-2022 con el fin poder entregar mayores antecedentes a la hora de tomar decisiones a nivel provincial 
  
  - Obj Especificos:
    - Obtener, recopilar y extraer las caracteristicas más importantes que aporten al estudio de la investigación 

    - Descripción y asociación de variables predictoras con respecto a la cantidad promedio de días.
    
    - validación la base de datos y modificar su estructura para los fines de este estudio
    
    <!-- -Método y selección de variables -->


### Plateamiento de la hipótesis en el estudio
<!-- ¿Qué es lo que quiero problematizar o comprobar? -->
  <!-- - Se desea validar que (definición de hipotesis) -->
  
  - Se quiere determinar si la evaluación docente esta indirectametne relacionada con el promedio de días tomados por licencias medicas de los mismos docentes 
  
  
## Generación de unidades de información

### Diseño de estrategias metodológicas
<!-- : ¿Qué metodologías utilizaré?; -->
<!-- ¿Cómo voy a alcanzar los objetivos que he construido? -->


Debido a lo que se quiere explicar, se plantea
metodologia a traves de regresiones lineales debido a que se quiere explocar ....


## Procesamiento de las unidades de información

<!-- Análisis de datos: ¿Qué dicen los datos? -->

<!-- La base de datos esta compuesta por $1.109$ observaciones y $15$ columnas detalladas a continuación: -->

### Descripción de los datos 

\begin{center}
    \begin{tabular}{|c|}
        \hline
        \textbf{Base de datos de Licencias Médicas}\\
        \begin{tabular}{|p{5cm}|p{2cm}|p{8cm}|}
            \hline
             \textbf{Variable} & \textbf{Tipo} & \textbf{Descripción}\\
             \hline
             SEXO & Factor & Sexos encontrados: Masculino o femenino\\
            \hline
             ESTADO\_CIVIL & Factor & Relación de familia, provenientes al matrimonio \\
            \hline
             EDAD & Double & ...\\
            \hline
             RENTA\_PROMEDIO & Double & ...\\
            \hline
             SISTEMA\_SALUD & Factor & ...\\
            \hline 
             JORNADA & Double & ...\\
            \hline             
             NIVEL & Factor & ...\\
            \hline                         
             TIPO\_ESTABLECIMIENTO & Factor &...\\
            \hline                                    
             CALIDAD\_DESEMPEÑO & Factor & profe jefe o no \\
            \hline  
             TRAMO\_DOCENTE & Factor &...\\
            \hline                          
             EVALUACION\_DOCENTE & Factor &...\\
            \hline  
             PROMEDIO\_DIAS\_LM & Double & ...\\
            \hline                          
             TRASLADO\_COMUNA & Double &...\\
            \hline                  
        \end{tabular}\\
        \\
        \hline
    \end{tabular}
\end{center}


Detalle de ETL de los datos

```{r fig.align="center", warning=FALSE, message=FALSE, out.width="70%", include = FALSE}
library(readxl)
library(tidyverse)

library(dplyr)
library(knitr)
library(ggplot2)
library(scales)
library(cowplot)
library(patchwork)
library(hrbrthemes)
library(viridis)


setwd("~/Desktop/MAGISTER/modelos_lineales/")
BBDD_proyecto <- read_excel("BBDD_FINAL_Mod_Lin.xlsx")
```



```{r fig.align="center", warning=FALSE, message=FALSE, out.width="90%", out.height="99%"}
BBDD_proyecto <- BBDD_proyecto %>% mutate_at(c("SEXO","ESTADO_CIVIL",
                              "SISTEMA_SALUD","NIVEL",
                              "TIPO_ESTABLECIMIENTO",
                              "CALIDAD_DESEMPEÑO",
                              "COMUNA_ESTABLECIMIENTO",
                              "ESTAMENTO","TRAMO_DOCENTE"),factor)

BBDD_proyecto$EVALUACION_DOCENTE <- factor(BBDD_proyecto$EVALUACION_DOCENTE,
                                           levels = c("SIN EVALUACIÓN",
                                                      "DESTACADO",
                                                      "BASICO",
                                                      "INSATISFACTORIO",
                                                      "COMPETENTE"))

BBDD_proyecto_sin_ceros <- BBDD_proyecto %>% filter(PROMEDIO_DIAS_LM != 0)
```

\newpage

## Estadística Descriptiva

A continuación se presenta análisis descriptivos para las variables más relevantes del estudio, de las cuales destacamos días promedios de licencias médicas, .....


### Distribución de Licencias Médicas

El gráfico de la izquierda muestra la distribución de licencias médicas que incluyen a los docentes/funcionarios que no han presentado licencias médicas hasta la fecha, en el gráfico de la derecha se muestra la distribución de licencias médicas pero descartando los casos de docentes/funcionarios que no han presentado licencias médicas, siendo este el grupo de personas empleadas para el análisis


```{r fig.align="center", warning=FALSE, message=FALSE, echo=FALSE,out.width="80%", out.height="100%"}
p1<- ggplot(BBDD_proyecto, aes(x = PROMEDIO_DIAS_LM)) +
  geom_histogram(aes(y =..density..), colour = "black", fill = "white") +
  geom_density(alpha = 0.6 , fill = "#FF6666", lwd = 1,colour = 2)+
  geom_vline(aes(xintercept = mean(PROMEDIO_DIAS_LM)),
             color = "blue", linetype = "dashed", size = 1)+
  theme_minimal()+
  labs(
  title="Distribución de Licencias Médicas",
  subtitle = "Considerando día cero",
  y="Densidad",
  x="Días Promedios",
   caption = "Elaboración Propia"
  )
  

p2<- ggplot(BBDD_proyecto_sin_ceros, aes(x = PROMEDIO_DIAS_LM)) +
  geom_histogram(aes(y =..density..), colour = "black", fill = "white") +
  geom_density(alpha = 0.6 , fill = "#FF6666", lwd = 1,colour = 2)+
  geom_vline(aes(xintercept = mean(PROMEDIO_DIAS_LM)),
             color = "blue", linetype = "dashed", size = 1)+
  theme_minimal()+
  labs(
  title="Distribución de Licencias Médicas",
  subtitle = "Descartando día cero",
  y="Densidad",
  x="Días Promedios",
  caption = "Elaboración Propia"
  )

cowplot::plot_grid(p1,p2)

```

```{r fig.align="center", warning=FALSE, message=FALSE, out.width="80%", out.height="100%", echo=FALSE}
# Variable Sexo
p1<- ggplot(data=BBDD_proyecto_sin_ceros, aes(x=SEXO))+
  geom_bar()+
  scale_y_continuous(limits = c(0,500))+
  geom_text(stat='count', aes(x = SEXO, label = ..count..), vjust = 2, color="white")+
  labs(
    title="Distribución de la variable Sexo",
    y="Frecuencia",
    x="Sexo",
    caption = "Elaboración Propia"
  )+
  theme_minimal()

p2 <-ggplot(data=BBDD_proyecto_sin_ceros, aes(x=EDAD))+
  geom_histogram(aes(y =..density..), colour = "black", fill = "white") +
  geom_density(alpha = 0.6 , fill = "#FF6666", lwd = 1,colour = 2)+
  labs(
    title="Distribución de la variable Edad",
    subtitle = "ambos sexos",
    y="Frecuencia",
    x="Edad",
    caption = "Elaboración Propia"
  )+
  theme_minimal()

cowplot::plot_grid(p1,p2)

```

De acuerdo a los resultados, la variable edad parece tener una distribución bimodal, de hecho, nos da luces de uan cierta mezcla de distribuciones, por lo cual se hace necesario el poder analizar esta variable de acuerdo a variables categórigas como es el sexo.


```{r, message=FALSE, warning=FALSE, echo=FALSE}
# bases de datos por sexo
df_final_femenino<- BBDD_proyecto_sin_ceros %>% filter(SEXO=="FEMENINO")
df_final_masculino<- BBDD_proyecto_sin_ceros %>% filter(SEXO=="MASCULINO")

# Edad de Genero femenino
p1<-ggplot(data=df_final_femenino, aes(x=EDAD))+
     geom_histogram(aes(y =..density..), colour = "black", fill = "white") +
     geom_density(alpha = 0.6 , fill = "#FF6666", lwd = 1,colour = 2)+
     labs(
       title="Distribución de la variable Edad",
       subtitle = "Género Femenino",
       y="Frecuencia",
       x="Edad"
     )+
     theme_minimal()

# Edad de Genero femenino
p2<-ggplot(data=df_final_masculino, aes(x=EDAD))+
     geom_histogram(aes(y =..density..), colour = "black", fill = "white") +
     geom_density(alpha = 0.6 , fill = "#FF6666", lwd = 1,colour = 2)+
     labs(
       title="Distribución de la variable Edad",
       subtitle = "Género Masculino",
       y="Frecuencia",
       x="Edad"
     )+
     theme_minimal()

# Edad de Genero
p3<-ggplot(data=BBDD_proyecto_sin_ceros, aes(x=SEXO, y=EDAD))+
     geom_boxplot() +
     labs(
       title="Distribución de la variable Edad",
       subtitle = "Por Sexo",
       y="Edad",
       x="Sexo",
       caption = "Elaboración Propia"
     )+
    geom_jitter(aes(colour = SEXO))+
    theme_minimal()


p3 + (p1/p2)

```

En este sentido, la distribución de edades en mujeres y homnbres es bastante similar, en cada sexo se puede apreciar una distribución bimodal.



```{r, message=FALSE, warning=FALSE, echo=FALSE,  out.width="80%", out.height="100%"}
summary(BBDD_proyecto_sin_ceros$RENTA_PROMEDIO)

# Renta Promedio
p1<-ggplot(data=BBDD_proyecto_sin_ceros, aes(x=RENTA_PROMEDIO))+
     geom_histogram(aes(y =..density..), colour = "black", fill = "white") +
     geom_density(alpha = 0.6 , fill = "#FF6666", lwd = 1,colour = 2)+
     labs(
       title="Distribución de la variable",
       subtitle = "Renta Promedio",
       y="Frecuencia",
       x="Renta Promedio"
     )+
     theme_minimal()

# Renta Promedio
p2<-ggplot(data=BBDD_proyecto_sin_ceros, aes(y=RENTA_PROMEDIO))+
     geom_boxplot() +
     labs(
       title="Distribución de la variable",
       subtitle = "Renta Promedio",
       y="Distribución",
       x="Renta Promedio",
       caption = "Elaboración Propia"
     )+
    theme(legend.position = "none")+
    scale_fill_brewer(palette = "Set2")

p1 + p2

```

En este caso la distribución de la renta está centrada alrededor de 1,7 millones de pesos, donde el 25% más bajo de la distribución de renta está por debajo de los 1.37 millones, mientras que el 25% de los casos con mayores rentas se encuentran entre 1.93 y 3.42 millones de pesos.

```{r, message=FALSE, warning=FALSE, echo = FALSE,  out.width="80%", out.height="100%"}
summary(df_final_femenino$RENTA_PROMEDIO)
summary(df_final_masculino$RENTA_PROMEDIO)

ggplot(BBDD_proyecto_sin_ceros, aes(SEXO, RENTA_PROMEDIO)) +
  geom_boxplot(aes(fill=SEXO))+
  xlab("SEXO")+
  ylab("Renta Promedio")+
  labs(title = "Distribución de variables por la renta promedio",
       subtitle = "Boxplot por sexo",
       caption = "Elaboración Propia")  +
  labs(fill = "Sexo") +  
  theme(
    legend.position = "none"
  )+
  scale_fill_brewer(palette = "Set2")+
  geom_jitter(color="black", size=0.3, alpha=0.9)
```

Comparando los niveles de renta por sexo se puede notar una cierta similitud en el rango de montos promedio, más aún, las estadísticas de posición (cuartiles) son bastante similares, por lo que podría no haber un efecto del sexo sobre los ingresos promedio. Para las mujeres la mediana de las rentas promedio es 1.58 millones, mientras que para los hombre bordea los 1.62 millones de pesos.

```{r, message=FALSE, warning=FALSE,  out.width="80%", out.height="100%",  echo = FALSE}
# Sistemas de salud por sexo
ggplot(data=BBDD_proyecto_sin_ceros, aes(x=SEXO, fill=SISTEMA_SALUD))+
  geom_bar()+
  geom_text(stat='count', aes(x = SEXO, label = ..count..), vjust = 1.5, color="black")+
  scale_y_continuous(limits = c(0,400))+
  labs(
    title="Distribución de la variable Sistemas de salud",
    y="Frecuencia",
    x="Sistemas de salud"
  )+
  theme_minimal()

```

Según los datos, la proporción de personas que pertenecen al sistema de salud fonasa es alto tanto en hombres como en mujeres, esto tiene sentido desde el punto de vista que es una base de información de la provincia de Huasco donde existe una alta mayor´´ia de zonas rurales donde el sistema fonasa es predominante.

```{r, message=FALSE, warning=FALSE,  out.width="80%", out.height="100%", echo = FALSE}
summary(BBDD_proyecto_sin_ceros$JORNADA)

# Variable Jornada
ggplot(data=BBDD_proyecto_sin_ceros, aes(x=JORNADA))+
  geom_histogram()+
  geom_text(stat='count', aes(x = JORNADA, label = ..count..), vjust = -1, hjust=2 , color="black")+
  scale_x_continuous(limits = c(15,90))+
  scale_y_continuous(limits = c(0,40))+
  labs(
    title="Distribución de la variable Jornada por sexo",
    y="Frecuencia",
    x="Sexo"
  )+
  theme_minimal()
```

Podemos notar que prácticamente el 75% de los las personas de la muestra trabajan jornadas de 44 o menos horas semanales, mientras que sólo un caso muestra 88 horas laborales semanales, este caso se debe a ..... (justificar el caso) 




```{r, message=FALSE, warning=FALSE,out.width="80%", out.height="100%", echo = FALSE}
# Estado Vicil
ggplot(data=BBDD_proyecto_sin_ceros, aes(x=ESTADO_CIVIL))+
  geom_bar()+
  geom_text(stat='count', aes(x = ESTADO_CIVIL, label = ..count..), vjust = -1, color="black")+
  scale_y_continuous(limits = c(0,500))+
  labs(
    title="Distribución de la variable Estado Civil",
    y="Frecuencia",
    x="Estado Civil"
  )+
  theme_minimal()
```

texto


```{r, message=FALSE, warning=FALSE, echo = FALSE}
# Evaluación Docente
ggplot(data=BBDD_proyecto_sin_ceros, aes(x=EVALUACION_DOCENTE))+
  geom_bar()+
  geom_text(stat='count', aes(x = EVALUACION_DOCENTE, label = ..count..), vjust = -1, color="black")+
  scale_y_continuous(limits = c(0,500))+
  labs(
    title="Distribución de la variable Evaluación Docente",
    y="Frecuencia",
    x="Evaluación Docente",
    caption = "Elaboración Propia"
  )+
  theme_minimal()
```

```{r, message=FALSE, warning=FALSE, echo = FALSE}
# Evaluación Docente
ggplot(data=BBDD_proyecto_sin_ceros, aes(x=TRAMO_DOCENTE))+
  geom_bar()+
  geom_text(stat='count', aes(x = TRAMO_DOCENTE, label = ..count..), vjust = -1, color="black")+
  scale_y_continuous(limits = c(0,500))+
  labs(
    title="Distribución de la variable Evaluación Docente",
    y="Frecuencia",
    x="Evaluación Docente",
    caption = "Elaboración Propia"
  )+
  theme_minimal()
```



## Selección Formal de Modelo

Para la selección del modelo forward se utilizo una significancia del 5% en cada uno de los test de hipótesis realizados

```{r fig.align="center", warning=FALSE, message=FALSE, out.width="90%", out.height="99%"}
modelo0 = lm(PROMEDIO_DIAS_LM ~ 1, data = BBDD_proyecto_sin_ceros)
add1(modelo0, ~ .  + SEXO + ESTADO_CIVIL + EDAD + RENTA_PROMEDIO +
       SISTEMA_SALUD + JORNADA + NIVEL + CALIDAD_DESEMPEÑO +
       ESTAMENTO + EVALUACION_DOCENTE + TRAMO_DOCENTE + TRASLADO_COMUNA,
     test="F") 
```

Para decidir la entrada del segundo predictor, se debe evaluar todos los modelos que ya contienen al promedio de días de licencias medicas, a lo que se agrega cada uno de los predictores restantes por separado.

De acuerdo al caso anterior, el menor valor-p corresponde al modelo PROMEDIO_DIAS_LM ~ EVALUACION_DOCENTE

```{r fig.align="center", warning=FALSE, message=FALSE, out.width="90%", out.height="99%"}
modelo0 = lm(PROMEDIO_DIAS_LM ~ EVALUACION_DOCENTE, data = BBDD_proyecto_sin_ceros)
add1(modelo0, ~ .  + SEXO + ESTADO_CIVIL + EDAD + RENTA_PROMEDIO +
       SISTEMA_SALUD + JORNADA + NIVEL + CALIDAD_DESEMPEÑO +
       ESTAMENTO + EVALUACION_DOCENTE + TRAMO_DOCENTE + TRASLADO_COMUNA,
     test="F") 


modelo0 = lm(PROMEDIO_DIAS_LM ~ EVALUACION_DOCENTE + CALIDAD_DESEMPEÑO, 
             data = BBDD_proyecto_sin_ceros)
add1(modelo0, ~ .  + SEXO + ESTADO_CIVIL + EDAD + RENTA_PROMEDIO +
       SISTEMA_SALUD + JORNADA + NIVEL + CALIDAD_DESEMPEÑO +
       ESTAMENTO + EVALUACION_DOCENTE + TRAMO_DOCENTE + TRASLADO_COMUNA,
     test="F") 


modelo0 = lm(PROMEDIO_DIAS_LM ~ EVALUACION_DOCENTE + CALIDAD_DESEMPEÑO +NIVEL, 
             data = BBDD_proyecto_sin_ceros)
add1(modelo0, ~ .  + SEXO + ESTADO_CIVIL + EDAD + RENTA_PROMEDIO +
       SISTEMA_SALUD + JORNADA + NIVEL + CALIDAD_DESEMPEÑO +
       ESTAMENTO + EVALUACION_DOCENTE + TRAMO_DOCENTE + TRASLADO_COMUNA,
     test="F") 


modelo0 = lm(PROMEDIO_DIAS_LM ~ EVALUACION_DOCENTE + CALIDAD_DESEMPEÑO +NIVEL + EDAD, 
             data = BBDD_proyecto_sin_ceros)
add1(modelo0, ~ .  + SEXO + ESTADO_CIVIL + EDAD + RENTA_PROMEDIO +
       SISTEMA_SALUD + JORNADA + NIVEL + CALIDAD_DESEMPEÑO +
       ESTAMENTO + EVALUACION_DOCENTE + TRAMO_DOCENTE + TRASLADO_COMUNA,
     test="F") 
     
summary(modelo0)

```


|Coeficientes | Estimación | Std. Error | t value | Pr(>t)|
|:---------|:---------:| :---------:|:---------:|:---------:|
|Intercepto | 7.59163 | 1.49024 |5.094|4.6e-07 |
|EVALUACION_DOCENTEDESTACADO|-2.69256|1.55890|-1.727|0.08460 |
|EVALUACION_DOCENTEBASICO|-2.08287 |1.13656|-1.833|0.06732 |
|EVALUACION_DOCENTEINSATISFACTORIO|7.87294 |1.52249|5.171|3.1e-07|
|EVALUACION_DOCENTECOMPETENTE|-1.91725 |1.12365|-1.706|0.08844|
|CALIDAD_DESEMPEÑOTITULAR|2.65846|0.72190|3.683|0.00025 |
|NIVELMEDIA|-1.84583|0.63467|-2.908|0.00376 |
|EDAD|0.06085|0.02425|2.509|0.01233|

